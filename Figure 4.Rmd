---
title: "Figure 4"
author: "Farhan Ameen"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: true
    code_folding: hide
    self_contained: yes
    theme: spacelab
editor_options: 
  chunk_output_type: inline
---

# Setup


```{r kerenSurvivalFeatures}
noColdSCE = kerenSCE |> 
  filter(!imageID %in% c(22,38)) |> 
  filter(tumour_type != "cold")

kerenPatientDf = noColdSCE |> 
  colData() |> 
  data.frame() |> 
  select(-c(x, y, CellID, cellType, cellSize, C, tumorYN, tumorCluster, Group, immuneCluster,
            immuneGroup)) |> 
  unique() |> 
  remove_rownames()
  
# Removing cold tumour type
noColdIdx = kerenPatientDf |> 
  pull(imageID)


# Kontextual values
kerenKontextMat = Statial::prepMatrix(kerenKontext) %>% 
  replace(is.na(.), 0) 
  

# Kontextual values - Treekor
kerenKontextTreeMat = Statial::prepMatrix(kerenTreeKontext)%>%
  replace(is.na(.), 0)


# L-function values
kerenOgMat = kerenKontext |> 
  filter(imageID %in% noColdIdx) |> 
  separate(test, c("A", "B", "parent"), "__") |> 
  select("imageID", "A", "B", "original") |> 
  unique() |> 
  mutate(test = paste(A, B, sep = "__")) |> 
  select(-c("A", "B"))  |> 
  pivot_wider(names_from = "test", values_from = "original") |> 
  column_to_rownames("imageID") %>% 
  replace(is.na(.), 0)

# inhom L-function values
kerenOgInhomMat = kerenInhom |> 
  filter(imageID %in% noColdIdx) |> 
  separate(test, c("A", "B", "parent"), "__") |> 
  select("imageID", "A", "B", "original") |> 
  unique() |> 
  mutate(test = paste(A, B, sep = "__")) |> 
  select(-c("A", "B"))  |> 
  pivot_wider(names_from = "test", values_from = "original") |> 
  column_to_rownames("imageID") %>% 
  replace(is.na(.), 0)



# Cell Proportions
kerenPropMat = spicyR::getProp(noColdSCE, feature = "cellType") 


# Treekor
clust_tree <- getClusterTree(t(assay(noColdSCE, "intensities")),
                             noColdSCE$cellType,
                             hierarchy_method = "hopach")


parentProp = getCellProp(phylo=clust_tree$clust_tree,
                       clusters= noColdSCE$cellType,
                       samples= noColdSCE$imageID,
                       classes= noColdSCE$tumour_type) |> 
  select(-class) |> 
  arrange(sample_id) |> 
  column_to_rownames("sample_id")



kerenFeatureList = list(
  "Cell type proportions" = kerenPropMat,
  "Parent proportions" = parentProp,
  "L-function" = kerenOgMat,
  "Inhomogeneous L-function" = kerenOgInhomMat, 
  "Kontextual" = kerenKontextMat,
  "Kontextual (treekor)" = kerenKontextTreeMat
)

# Sanity check
kerenFeatureList = lapply(kerenFeatureList, function(x){
  x |> rownames_to_column("imageID") |>
    mutate(imageID = as.numeric(imageID)) |>
    arrange(imageID) |>
    filter(imageID %in% noColdIdx)  |>
    column_to_rownames("imageID")
})


kerenFeatureListNo100 = lapply(kerenFeatureList, function(x){
  x %>% 
  replace(x == -100, 0)
})

kerenSurv = Surv(kerenPatientDf$Survival_days_capped., kerenPatientDf$event)
names(kerenSurv) = kerenPatientDf$imageID


measurementsOutcome = ClassifyR::prepareData(kerenFeatureList, kerenSurv)
featuresMulti = measurementsOutcome$measurements


```


# Panel A: Survival curves


## Plotting survival curve

```{r}

# Calculating p values 
# There are no 0s or -100s so no need to filter
survCurveData = data.frame(
  imageID = names(kerenSurv),
  lfunction = kerenFeatureList$`L-function`$`Keratin+ Tumour__CD8`,
  kontextual = kerenFeatureList$Kontextual$`Keratin+ Tumour__CD8__immune`,
  surv = kerenSurv
) 

kontSurv = coxph(surv ~ kontextual, data = survCurveData)
kontPval = summary(kontSurv)$coefficients[5] |> 
  round(3)

lSurv = coxph(surv ~ lfunction, data = survCurveData)
lPval = summary(lSurv)$coefficients[5] |> 
  round(3)


pvals = data.frame(
  test = c("Kontextual", "L-function"),
  lab = c(paste("p=", kontPval, sep = ""),
          paste("p=", lPval, sep = ""))
)


# Plotting survival curves
plotData = survCurveData |> 
  mutate(
  "L-function" = ifelse(lfunction > median(lfunction), "Attraction", "Avoidance"),
  "Kontextual" = ifelse(kontextual > median(kontextual), "Attraction", "Avoidance")) |>
  # mutate(
  # "L-function" = ifelse(lfunction > 0, "Attraction", "Avoidance"),
  # "Kontextual" = ifelse(kontextual > 0, "Attraction", "Avoidance")) |> 
  select(-c(lfunction, kontextual)) |> 
  pivot_longer(-c(imageID,surv), names_to = "test", values_to = "values")



fit = survfit2(surv ~ values, data = plotData)

survCurve = ggsurvplot_facet(fit, plotData, facet.by = "test",
                 palette = "jco",
                 short.panel.labs = TRUE) +
  geom_text(data = pvals, aes(x = 1000, y = 0.45, label = lab), size = 4.5)+
  ylim(0.3, 1 ) +
  labs(col = "Localisation",
       x = "Time (days)") +
  theme_bw() +
  theme(
    axis.title.x = element_text(size = 15, vjust = -1),
    axis.title.y = element_text(size = 15, vjust = 2),
    axis.text = element_text(size = 12, colour = "black"),
    legend.position = "bottom",
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    strip.background = element_rect(
      fill = "white",
      size = 0,
      linetype = "blank"
    ),
    strip.text.x = element_text(size = 15, color = "black")
  ) +
  theme(legend.position = "none")


ggplotly(survCurve)


```


## Plotting relationship value bar plot

```{r}

plotData = survCurveData |> 
  mutate(
  "lfunc" = ifelse(lfunction > median(lfunction), "Attraction", "Avoidance"),
  "kontext" = ifelse(kontextual > median(kontextual), "Attraction", "Avoidance"))

plotAttract = plotData |> 
  select(-c(lfunction, kontextual)) |> 
  pivot_longer(-c(`imageID`, `surv`),
               names_to = "test", 
               values_to = "attraction") |> 
  mutate(test = case_when(test == "lfunc" ~ "lfunction",
                          test == "kontext" ~ "kontextual"))


plotVals = plotData |> 
  select(-c(lfunc, kontext)) |> 
  pivot_longer(-c(`imageID`, `surv`),
               names_to = "test", 
               values_to = "values")

combinedPlotData = left_join(plotVals, plotAttract,
                             by = c("imageID" = "imageID", "test" = "test"), 
) |> 
  select(-surv.y) |> 
  rename("surv" = "surv.x")


xupper = 35
xlower = -65

lmin = -65
lmed = median(survCurveData$lfunction) 
lmax = 5.0

kmin = -50
kmed = median(survCurveData$kontextual)
kmax = 35

lannotate = data.frame(new = 0,
                       test = "lfunction",
                       xmin = c(lmin, lmed),
                       xmax = c(lmed, lmax),
                       ymin = -1,
                       ymax = 1,
                       attraction = c("Avoidance", "Attraction"))


kannotate = data.frame(new = 0,
                       test = "kontextual",
                       xmin = c(kmin, kmed),
                       xmax = c(kmed, kmax),
                       ymin = -1,
                       ymax = 1,
                       attraction = c("Avoidance", "Attraction"))

patientAnnotations = combinedPlotData |> 
  mutate(new = 0) %>% 
  ggplot() +
  geom_rect(data = lannotate,
            aes(y = new, xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = attraction), alpha = 0.5) + 
  geom_rect(data = kannotate,
            aes(y = new, xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = attraction), alpha = 0.5) + 
  geom_point(aes(y = new, x = values, col = attraction)) +
  facet_wrap(~test, scales = "free_x",
             labeller = labeller(test = c("lfunction" = "L-function", "kontextual" = "Kontextual"))) +
  scale_colour_manual(values = list("Attraction" = "#0073C2FF", "Avoidance" = "#EFC000FF")) +
  scale_fill_manual(values = list("Attraction" = "#0073C2FF", "Avoidance" = "#EFC000FF")) +
  labs(x = "Relationship value (split on median)") +
  theme_void() +
  theme(legend.position = "none",
        aspect.ratio = 0.1,
        panel.spacing = unit(3.5, "lines"),
        plot.margin = margin(0,1,0,0, "cm")) +
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  theme(axis.text.x = element_text(vjust = -1.5, colour = "black", size = 12),
        axis.title.x = element_text(vjust = -5, colour = "black", size = 14)) +
  ggh4x::facetted_pos_scales(x = list(
    test == "kontextual" ~ scale_x_continuous(breaks = c(kmin, round(kmed,1), kmax)),
    test == "lfunction" ~ scale_x_continuous(breaks = c(lmin, round(lmed, 1), lmax))
))
  
```

## Combining and saving survival curves

```{r}
survCurveFinal = survCurve/patientAnnotations + 
  plot_layout(heights = c(10,3), guides = "collect")

ggsave("figures/keren/keratinCD8SurvCurve.pdf", survCurveFinal, height = 5, width = 8)
```

# Panel B: Example images

## Finding representative images
```{r}
feature = "Keratin+ Tumour__CD8__immune"

survCurveData |> 
  mutate(
  "L-function" = ifelse(lfunction > median(lfunction), "Attraction", "Avoidance"),
  "Kontextual" = ifelse(kontextual > median(kontextual), "Attraction", "Avoidance")
) |> filter(`L-function` != `Kontextual`)



plotDat = data.frame("event" = kerenPatientDf$event,
           "surv" = kerenPatientDf$Survival_days_capped.,
           "kont" = kerenFeatureList$Kontextual[[feature]],
           #"l" = inhomMat[[feature]],
           "imageID" = kerenPatientDf$imageID, 
           "type" = kerenPatientDf$tumour_type
           ) |> 
  filter(kont != 0) |> 
  filter(kont != -100)

p = plotDat |> 
  filter(type == "compartmentalised") |> 
  ggplot( aes(x = kont, y = surv, col = as.factor(event), text = imageID)) +
  geom_text(aes(label = imageID), vjust = -0.5) +
  #geom_vline(xintercept = median(plotDat$kont), col = "red", linetype = "dashed") +
  geom_vline(xintercept = median(0), col = "red", linetype = "dashed") +
  geom_point() +theme_classic()

p

```
## Ploting and saving patient 16 and 9 images

```{r}
feature = "Keratin+ Tumour__CD8__immune"


plotSurvImages = function(image) {
  from = "Keratin+ Tumour"
  to = "CD8"
  parent = immune
  parentName = "Immune"
  
  scale = 2048/800
  
  # plot data
  plotData = kerenSCE |>
    colData() |>
    data.frame() |>
    filter(cellType %in% c(parent, to, from)) |>
    mutate(plotCells = case_when(cellType == from ~ from,
                                 cellType == to ~ to,
                                 TRUE ~ parentName)) |>
    mutate(plotCells = factor(plotCells, levels = c(parentName, from, to))) |>
    arrange(plotCells)
  
  
  colours = list("Keratin+ Tumour" = "#404040", "Immune" = "#D7D8D8", "CD8" = "#E25758")
  
  plot = plotData |>
    filter(imageID == image) |>
    ggplot(aes(x = x, y = y, col = plotCells)) +
    geom_point() +
    scale_color_manual(values = colours) +
    theme_void() +
    theme(legend.position = "none") +
    geom_segment(aes(y = -100, yend = -100,
                     xend = max(plotData$x), x = max(plotData$x) - 100*scale),
                 linewidth = 1, lineend= "round", show.legend = F, col = "black")
  
  return(plot)
}



goodImage = plotSurvImages(9)
goodImage

poorImage =  plotSurvImages(16)
poorImage

# ggsave("figures/keren/tumourCD8good9.pdf", goodImage, height = 5, width = 6)
# ggsave("figures/keren/tumourCD8poor16.pdf", poorImage, height = 5, width = 6)
```

# Panel C: Bubble plot


## Creating bubblePlot
```{r bubblePlot function}


# Create function which calculates coxtests
coxTests = function(measurementMat, Surv, remove = c(0, -100), type = "cont", pvalMethod = "fdr") {
  
  modifiedMat = apply(measurementMat, 2, function(measurementCol) {
    ind = !(measurementCol %in% remove)
    measurementCol = measurementCol[ind]
    
    if(type == "median") {
      measurementCol = if_else(measurementCol > median(measurementCol), "Attraction", "Avoidance")
    }
    
    if(type == "0"){
       measurementCol = if_else(measurementCol > 0, "Attraction", "Avoidance")
       if (sum(measurementCol == "Attraction") == 0 |
           sum(measurementCol == "Avoidance") == 0) {
         return(NA)
       }
    }
    
    return(measurementCol)
  })
  
  modifiedMat = modifiedMat[!is.na(modifiedMat)]
  
  result = lapply(names(modifiedMat), function(test){
    ind = !(measurementMat[[test]] %in% remove)
    fit = coxph(Surv[ind] ~ modifiedMat[[test]])
    summary(fit)$coefficients[1, c(1, 3, 5)]
  })

    
  result = result |> 
    bind_rows() |> 
    mutate(test = names(modifiedMat)) |> 
  rename( "se.coef" = "se(coef)",
          "p.value" = "Pr(>|z|)") |> 
  select(test, coef, se.coef, p.value)
  
  result$`adj.p.value` = p.adjust(result$`p.value`, method = pvalMethod)

  return(result)

}



survBubble = function(kontextMat, surv, remove = c(0, -100), type = "cont") {
  coxMat = coxTests(kontextMat, surv,remove = remove, type = type) %>%
    mutate_if(is.numeric, signif, digits = 2) |>
    arrange(p.value)
  
  factor_order = c(
    "CD3 T",
    "CD4 T",
    "CD8 T",
    "Regulatory T" ,
    "Naive T",
    "NK",
    "B",
    "Neutrophils",
    "Macrophages",
    "DC",
    "DC/Mono",
    "Mono/Neu",
    "Other immune",
    "Endothelial",
    "Mesenchymal",
    "Tumour",
    "Keratin+ Tumour",
    "Unidentified"
  )
  
  plotData = coxMat |>
    separate(test,
             into = c("from", "to", "parent"),
             sep = "__") |>
    arrange(parent, to, from) |>
    mutate(
      to = case_when(
        to == "CD8" ~ "CD8 T",
        to == "CD4" ~ "CD4 T",
        to == "CD3" ~ "CD3 T",
        to == "Tregs" ~ "Regulatory T",
        TRUE ~ to
      ),
      from = case_when(
        from == "CD8" ~ "CD8 T",
        from == "CD4" ~ "CD4 T",
        from == "CD3" ~ "CD3 T",
        from == "Tregs" ~ "Regulatory T",
        TRUE ~ from
      )
    ) |> 
    mutate(ogto= to,
           to = paste(to, parent, sep = "__")) |>
    mutate(
      sig = p.value < 0.05,
      logP = -log10(p.value),
      size = logP / max(logP, na.rm = TRUE),
      from = factor(from, levels = factor_order),
      to = factor(to, levels = factor_order),
      ogto = factor(ogto, levels = factor_order),
      parent = case_when(
        parent == "immune" ~ "Immune",
        parent == "stromal" ~ "Stromal",
        parent == "tcells" ~ "T cells",
        parent == "tumour" ~ "Tumour"
      )
    ) |> 
    mutate(parent = factor(parent, levels = c("T cells", "Immune", "Stromal", "Tumour")))
  
  palette = ggthemes_data$tableau$`color-palettes`$regular$`Tableau 10`$value
    
  colourDat = palette[1:length(unique(plotData$parent))]
  names(colourDat) = levels(plotData$parent)
  
  
  strip = strip_themed(background_x = elem_list_rect(fill =colourDat))
  
  ggplot(plotData, aes(x = ogto, y = from)) +
    geom_tile(aes(fill = parent), alpha = -1) +
    ggplot2::geom_point(ggplot2::aes(size = pmax(logP/2, 0.15), colour = coef)) +  
    geom_point(data = filter(plotData, sig == TRUE), aes(size = pmax(logP/2, 0.15)), shape = 21) +
    ggplot2::geom_point(ggplot2::aes(shape = "P < 0.05"), size = -1) + 
    facet_grid2(~parent, scales = "free", space = "free", strip = strip) +
    scale_colour_gradient2(low = "#4575B4", mid = "white", high = "#D73027") +
    scale_fill_manual(values = colourDat) + 
    scale_size(range = c(2, 8)) +
    scale_x_discrete(guide = guide_axis(angle = 45)) +
    labs(colour = "CoxPH \ncoefficient",
         fill = "Context",
         shape = NULL,
         x = NULL,
         y = NULL) +
    ggplot2::guides(shape = ggplot2::guide_legend(order = 2, override.aes = list(size=5, shape = 1, col = "black")),
                    colour = ggplot2::guide_colourbar(order = 3),
                    fill = guide_legend(order = 1, override.aes = list(alpha = 1)),
                    size = "none") +
    theme_classic() +
    theme(legend.title = element_text(size = 14),
          legend.text = element_text(size = 12),
          axis.text = element_text(size = 12, colour = "black"),
          strip.text = element_text(size = -1),
          strip.clip = "off",
          strip.background = element_rect(linewidth = NA),
          panel.spacing = unit(0.4,'lines'))

}


```


## Saving bubble plot
```{r bubblePlot, fig.height= 6, fig.width = 12}

bubblePlot = survBubble(kontextMat = kerenFeatureList$Kontextual, remove = c(0), kerenSurv, type = "cont")

bubblePlot


ggsave("figures/keren/bubble.pdf", bubblePlot, height = 6, width = 12, dpi = 500)
```

## Examining top survival relationships 
```{r}

coxMat = coxTests(kerenFeatureList$Kontextual, kerenSurv,remove = c(0), type = "cont") %>%
  mutate_if(is.numeric, signif, digits = 2) |>
  arrange(adj.p.value, abs(coef))

coxMat
```




# Panel D: Survival classification

```{r kerenSurvClassification}
set.seed(101)

measurements = kerenFeatureListNo100
outcome = kerenSurv
classifier = "CoxNet"
selectionMethod = "CoxPH"
multiViewMethod = "none"

nFolds = 10
nFeatures = 20
nRepeats = 100
nCores = 40

kerenSurvClassification = crossValidate(
  measurements = measurements,
  outcome = outcome,
  classifier = classifier,
  selectionMethod  = selectionMethod,
  multiViewMethod = multiViewMethod,
  nFolds = nFolds,
  nFeatures = nFeatures,
  nRepeats = nRepeats,
  nCores = nCores
  )


#saveRDS(kerenSurvClassification, "keren/kerenFinalSurvClassification.rds")
```


## Saving classification boxplot
```{r kerenSurvPlot}

kerenSurvClassification = readRDS("keren/kerenFinalSurvClassification.rds")

axis_names = names(kerenFeatureList)
axis_names[1] = "Cell type\nproportions"
axis_names[2] = "Parent proportions"
axis_names[4] = "Inhomogeneous\nL-function"
 


performancePlot(kerenSurvClassification[-4], metric = "C-index",
                characteristicsList = list(x = "auto"),
                orderingList = list("Assay Name" = names(kerenFeatureList)[-4])) +
  theme(legend.position = "none") +
  scale_x_discrete(guide = guide_axis(angle = 45),
                   labels = axis_names[-4]) +
  theme(axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 16),
        axis.title.y = element_text(size = 18)) +
  scale_fill_tableau() +
  labs(x = NULL)



test = kerenSurvClassification$`Cell type proportions.CoxNet.CoxPH` |> 
  calcCVperformance()


#ggsave("figures/keren/survClassification.pdf", height = 7, width = 8,  dpi = 750)
```

## Classification performance
```{r}
performance = lapply(kerenSurvClassification, function(res){
  perf = calcCVperformance(res) 
  return(perf@performance$`C-index` |> mean())
  
})
performance
```


# Supplementary: Patient 9 stability test


```{r patient9 stability}


otherImmune = immune[immune != "CD8"]

kerenSCE9 = kerenSCE |> 
  filter(imageID == 9) |> 
  mutate(cellType = case_when(cellType %in% otherImmune ~ "other immune",
                   TRUE ~ cellType))

tumourIDX = kerenSCE9 |> 
  filter(cellType == "Keratin+ Tumour") |> 
  pull(CellID)

CD8IDX = kerenSCE9 |> 
  filter(cellType == "CD8") |> 
  pull(CellID)

immuneIDX = kerenSCE9 |> 
  filter(cellType == "other immune") |> 
  pull(CellID)

contextIDX = kerenSCE9 |> 
  filter(cellType %in% c("other immune", "CD8")) |> 
  pull(CellID)


stabilityPerm = function(toRemoveList,
                         cellIDX,
                         iter,
                         from = "Keratin+ Tumour",
                         to = "CD8", 
                         val = "kontextual",
                         cores) {
  
  
  nCell = length(cellIDX)
  
  permutationRes = lapply(toRemoveList, function(toRemove) {
    
    bplapply(1:iter, function(x) {
      nRemove = round(nCell * toRemove)
      removeID = sample(cellIDX, nRemove)
      
      sce = kerenSCE9 |>
        filter(!(CellID %in% removeID))
      
      kontextResult = Statial::Kontextual(
        sce,
        from = from,
        to = to,
        parent = c("CD8", "other immune"),
        r = 100
      )
      
      if (val == "kontextual") {
        return(kontextResult$kontextual)
      } else{
        return(kontextResult$original)
      }
      
    }, BPPARAM = BiocParallel::MulticoreParam(workers = cores)) |>
      unlist()
    
  })
  
  names(permutationRes) = toRemoveList
  
  return(permutationRes)
  
}


set.seed(101)
toRemoveList = c(0.1, 0.3, 0.5, 0.7, 0.9)
iter = 50
cores = 20


immuneResultsKontext = stabilityPerm(toRemoveList = toRemoveList,
                              cellIDX = immuneIDX,
                              iter = iter,
                              cores = cores)



tumourResultsKontext = stabilityPerm(toRemoveList = toRemoveList,
                              cellIDX = tumourIDX,
                              iter = iter,
                              cores = cores)


CD8ResultsKontext = stabilityPerm(toRemoveList = toRemoveList,
                              cellIDX = CD8IDX,
                              iter = iter,
                              cores = cores)


contextResultsKontext = stabilityPerm(toRemoveList = toRemoveList,
                              cellIDX = contextIDX,
                              iter = iter,
                              cores = cores)


immuneResultsOriginal = stabilityPerm(toRemoveList = toRemoveList,
                              cellIDX = immuneIDX,
                              iter = iter,
                              #to = "other immune",
                              val = "original",
                              cores = cores)



tumourResultsOriginal = stabilityPerm(toRemoveList = toRemoveList,
                              cellIDX = tumourIDX,
                              iter = iter,
                              val = "original",
                              cores = cores)


CD8ResultsOriginal = stabilityPerm(toRemoveList = toRemoveList,
                              cellIDX = CD8IDX,
                              iter = iter,
                              val = "original",
                              cores = cores)

contextResultsOriginal = stabilityPerm(toRemoveList = toRemoveList,
                              cellIDX = contextIDX,
                              iter = iter,
                              val = "original",
                              cores = cores)

observedResult = Statial::Kontextual(
        kerenSCE9,
        from = "Keratin+ Tumour",
        to = "CD8",
        parent = c("CD8", "other immune"),
        r = 100
      )
```




## Chaning window size

```{r}


bigWindowSizes = c(1.25, 1.5, 2, 2.5, 3)
smallWindowSizes = c(0.33, 0.4, 0.5, 0.66, 0.8)
iter = 50
set.seed(100)

windowData = kerenSCE9 |> 
  as_tibble() |> 
  dplyr::select(x, y, cellType, imageID)

maxX = max(windowData$x)
maxY = max(windowData$y)


bigWindowDfs = lapply(bigWindowSizes, function(size){
  newDat = windowData |> 
    add_row(x = maxX*size, y = maxY*size, cellType = "windowTest" , imageID = "9")
  
  return(newDat)
  })



bigWindowResults = lapply(windowDfs, function(df){
  res = Kontextual(
    df,
    r = 100,
    from = "Keratin+ Tumour",
    to = "CD8",
    parent = c("CD8", "other immune")
  )
  
  return(res)
}) |> 
  bind_rows() |> 
  mutate(windowSize = windowSizes)



smallWindowResults = lapply(smallWindowSizes, function(size){
  xSize = maxX*size
  ySize = maxY*size
  
  maxSizeX = maxX - xSize
  maxSizeY = maxY - ySize
  
  sizeResults = bplapply(1:iter, function(x) {
        
      xStart = sample(0:maxSizeX, 1)
      yStart = sample(0:maxSizeY, 1)
      
      data = windowData |> 
        filter(x > xStart & x < (xStart + xSize)) |> 
        filter(y > yStart & y < (yStart + ySize))
      
      kontextResult = Statial::Kontextual(
        data,
        from = "Keratin+ Tumour",
        to = "CD8",
        parent = c("CD8", "other immune"),
        r = 100
      )
      
      return(data.frame(
        windowSize = c(size, size),
        iter = c(x, x),
        test = c("kontextual", "original"),
        value = c(kontextResult$kontextual, kontextResult$original)))
      
    }, BPPARAM = BiocParallel::MulticoreParam(workers = cores)) |>
      bind_rows()
    
  return(sizeResults)
  }) |> bind_rows()




combinedWindowResult = bigWindowResults |> 
  select(original, kontextual, windowSize) |> 
  pivot_longer(
    cols = c(original, kontextual),
    names_to = "test", 
    values_to = "value"
  ) |> 
  bind_rows(smallWindowResults)

kontextualWindowResults = combinedWindowResult |> 
  filter(test == "kontextual") 


originalWindowResults = combinedWindowResult |> 
  filter(test == "original") 

```

```{r}
combinedWindowResult |> 
  ggplot(aes(x = factor(windowSize), y = value)) +
  geom_beeswarm() +
  facet_wrap(~test) +
  geom_hline(yintercept = 0, lty = "dashed", col = "black") +
  labs(x = "Window scale",
       y = "Relationship Value")+
  theme_classic()
```


## Plotting results

```{r fig.width = 10, fig.height = 3}


plotStabilityResult = function(result, observedVal,  ylim) {
  
  p = result |> 
  data.frame(check.names = FALSE) |> 
  pivot_longer(everything()) |> 
    mutate(name = as.numeric(name)*100) |> 
    mutate(name = as.character(name)) |> 
  ggplot(aes(x = name, y = value)) +
  geom_boxplot() +
  geom_hline(yintercept = 0, col = "black", linetype = "dashed") +
  geom_hline(yintercept = observedVal, col = "red", linetype = "dashed") +
  theme_classic() +
  labs(x = "Percentage of cell type removed") +
   ylim
  
  return(p)
}

plotWindowResult = function(result, observedVal, ylim) {
  result |>
    ggplot(aes(x = factor(windowSize), y = value)) +
    geom_beeswarm() +
    geom_hline(yintercept = 0, lty = "dashed", col = "black") +
     geom_hline(yintercept = observedVal, col = "red", linetype = "dashed") +
    theme_classic() +
    labs(x = "Window size") +
    ylim
  
}


kontextYlim = ylim(-0.5, 60)
lFuncYlim = ylim(-30, 40)

stability9Kontext = 
plotStabilityResult(tumourResultsKontext,
                    observedVal = observedResult$kontextual,
                    ylim = kontextYlim) +
  labs(x = "% tumour cells removed \n (n = 2642)",
       y = "Kontextual value") +
plotStabilityResult(CD8ResultsKontext,
                    observedVal = observedResult$kontextual,
                    ylim = kontextYlim)  +
  labs(x = "% CD8 T cells removed \n (n = 391)",
       y = "Kontextual value") +
  plotStabilityResult(contextResultsKontext,
                    observedVal = observedResult$kontextual,
                    ylim = kontextYlim) +
  labs(x = "% immune context removed \n (n = 3272)",
       y = "Kontextual value") +
     plotStabilityResult(immuneResultsKontext,
                    observedVal = observedResult$kontextual,
                    ylim = kontextYlim) +
  labs(x = "% remaining immune cells removed \n (n = 2881)",
       y = "Kontextual value") +
  plotWindowResult(kontextualWindowResults,
                   observedVal = observedResult$kontextual,
                   ylim = kontextYlim) +
  labs(y = "Kontextual value") +
  plot_layout(axis_titles = "collect", ncol = 5) &
  theme(axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12))


stability9Kontext



stability9Original = plotStabilityResult(tumourResultsOriginal,
                    observedVal = observedResult$original,
                    ylim = lFuncYlim) +
  labs(x = "% tumour cells removed \n (n = 2642)",
       y = "L-function value") +
  plotStabilityResult(CD8ResultsOriginal, 
                    observedVal = observedResult$original,
                    ylim = lFuncYlim)  +
  labs(x = "% CD8 T cells removed \n (n = 391)",
       y = "L-function value") +
  plotStabilityResult(contextResultsOriginal,
                    observedVal = observedResult$original,
                    ylim = lFuncYlim) +
  labs(x = "% immune context removed \n (n = 3272)",
      y = "L-function value") +
     plotStabilityResult(immuneResultsOriginal,
                    observedVal = observedResult$original,
                    ylim = lFuncYlim) +
  labs(x = "% remaining immune cells removed \n (n = 2881)",
       y = "L-function value") +
  plotWindowResult(originalWindowResults,
                   observedVal = observedResult$original,
                   ylim = lFuncYlim) +
  labs(y = "L-function value") +
  plot_layout(axis_titles = "collect", ncol = 5) &
  theme(axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12))


stability9Original

ggsave("figures/survival/patient9stabilityKontext.pdf", plot = stability9Kontext, height = 4, width = 18)
ggsave("figures/survival/patient9stabilityOriginal.pdf", plot = stability9Original, height = 4, width = 18)


```





# ADD PROPOrtions of all images to the plot
dividing by proportions aims to address the mismatch

